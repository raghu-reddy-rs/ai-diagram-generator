var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import { logMemoryUsage, withMemoryLogging } from '../shared/memoryUtils.js';
import { collectFiles } from './file/fileCollect.js';
import { sortPaths } from './file/filePathSort.js';
import { processFiles } from './file/fileProcess.js';
import { searchFiles } from './file/fileSearch.js';
import { getGitDiffs } from './git/gitDiffHandle.js';
import { getGitLogs } from './git/gitLogHandle.js';
import { calculateMetrics } from './metrics/calculateMetrics.js';
import { generateOutput } from './output/outputGenerate.js';
import { copyToClipboardIfEnabled } from './packager/copyToClipboardIfEnabled.js';
import { writeOutputToDisk } from './packager/writeOutputToDisk.js';
import { validateFileSafety } from './security/validateFileSafety.js';
const defaultDeps = {
    searchFiles,
    collectFiles,
    processFiles,
    generateOutput,
    validateFileSafety,
    writeOutputToDisk,
    copyToClipboardIfEnabled,
    calculateMetrics,
    sortPaths,
    getGitDiffs,
    getGitLogs,
};
export const pack = (rootDirs_1, config_1, ...args_1) => __awaiter(void 0, [rootDirs_1, config_1, ...args_1], void 0, function* (rootDirs, config, progressCallback = () => { }, overrideDeps = {}, explicitFiles) {
    const deps = Object.assign(Object.assign({}, defaultDeps), overrideDeps);
    logMemoryUsage('Pack - Start');
    progressCallback('Searching for files...');
    const filePathsByDir = yield withMemoryLogging('Search Files', () => __awaiter(void 0, void 0, void 0, function* () {
        return Promise.all(rootDirs.map((rootDir) => __awaiter(void 0, void 0, void 0, function* () {
            return ({
                rootDir,
                filePaths: (yield deps.searchFiles(rootDir, config, explicitFiles)).filePaths,
            });
        })));
    }));
    // Sort file paths
    progressCallback('Sorting files...');
    const allFilePaths = filePathsByDir.flatMap(({ filePaths }) => filePaths);
    const sortedFilePaths = deps.sortPaths(allFilePaths);
    // Regroup sorted file paths by rootDir
    const sortedFilePathsByDir = rootDirs.map((rootDir) => ({
        rootDir,
        filePaths: sortedFilePaths.filter((filePath) => { var _a; return (_a = filePathsByDir.find((item) => item.rootDir === rootDir)) === null || _a === void 0 ? void 0 : _a.filePaths.includes(filePath); }),
    }));
    progressCallback('Collecting files...');
    const collectResults = yield withMemoryLogging('Collect Files', () => __awaiter(void 0, void 0, void 0, function* () {
        return yield Promise.all(sortedFilePathsByDir.map(({ rootDir, filePaths }) => deps.collectFiles(filePaths, rootDir, config, progressCallback)));
    }));
    const rawFiles = collectResults.flatMap((curr) => curr.rawFiles);
    const allSkippedFiles = collectResults.flatMap((curr) => curr.skippedFiles);
    // Get git diffs if enabled - run this before security check
    progressCallback('Getting git diffs...');
    const gitDiffResult = yield deps.getGitDiffs(rootDirs, config);
    // Get git logs if enabled - run this before security check
    progressCallback('Getting git logs...');
    const gitLogResult = yield deps.getGitLogs(rootDirs, config);
    // Run security check and get filtered safe files
    const { safeFilePaths, safeRawFiles, suspiciousFilesResults, suspiciousGitDiffResults, suspiciousGitLogResults } = yield withMemoryLogging('Security Check', () => deps.validateFileSafety(rawFiles, progressCallback, config, gitDiffResult, gitLogResult));
    // Process files (remove comments, etc.)
    progressCallback('Processing files...');
    const processedFiles = yield withMemoryLogging('Process Files', () => deps.processFiles(safeRawFiles, config, progressCallback));
    progressCallback('Generating output...');
    const output = yield withMemoryLogging('Generate Output', () => deps.generateOutput(rootDirs, config, processedFiles, safeFilePaths, gitDiffResult, gitLogResult));
    progressCallback('Writing output file...');
    yield withMemoryLogging('Write Output', () => deps.writeOutputToDisk(output, config));
    yield deps.copyToClipboardIfEnabled(output, progressCallback, config);
    const metrics = yield withMemoryLogging('Calculate Metrics', () => deps.calculateMetrics(processedFiles, output, progressCallback, config, gitDiffResult, gitLogResult));
    // Create a result object that includes metrics and security results
    const result = Object.assign(Object.assign({}, metrics), { suspiciousFilesResults,
        suspiciousGitDiffResults,
        suspiciousGitLogResults,
        processedFiles,
        safeFilePaths, skippedFiles: allSkippedFiles });
    logMemoryUsage('Pack - End');
    return result;
});
//# sourceMappingURL=packager.js.map